import { config } from "../../config"
import { Redis } from "../Redis"
import { NodeFactory, VpnNode } from "../nodes/node-factory"
import { VPNFactory } from "../vpn/vpn-factory"

export class ConfigManager {
    static async publishServerConfig(node: "global" | string) {
        const redis = await Redis.getInstance()

        if (node === "all") {
            const nodes = await new NodeFactory().getAll()
            await Promise.all(
                nodes.map(async (_node) => {
                    const clientsRecieved = await redis.publish(
                        `publish_config:${_node.hostname}`,
                        await this.computeServerConfig(
                            await this.computeClients(_node),
                            _node,
                        ),
                    )
                    if (clientsRecieved === 0) {
                        console.log(`vpn node ${_node.hostname} is offline.`)
                    }
                }),
            )
        } else {
            const vpnNode = await new NodeFactory().get(parseInt(node))

            const clientsRecieved = await redis.publish(
                `publish_config:${vpnNode.hostname}`,
                await this.computeServerConfig(
                    await this.computeClients(vpnNode),
                    vpnNode,
                ),
            )
            if (clientsRecieved === 0) {
                console.log(`vpn node ${vpnNode} is offline.`)
            }
        }
    }

    private static async computeClients(node: VpnNode) {
        const clients = await VPNFactory.getForNode(node.id)
        return clients.reduce(
            (arr, client) => {
                arr.push(
                    [
                        `# Client: ${client.alias} (${client.id}) - ${node.hostname}`,
                        "[Peer]",
                        `PublicKey = ${client.pub}`,
                        `PresharedKey = ${client.psk}`,
                        `AllowedIPs = ${client.ipv4}/32, ${client.ipv6}/128`,
                        "",
                    ].join("\n"),
                )

                return arr
            },
            [""],
        )
    }

    private static computeServerConfig(clients: any, node: VpnNode) {
        return [
            "# Note: Do not edit this file directly. It is generated by the RadicalVPN server.",
            "# Your changes will be overwritten!",
            `# Generated for Radical VPN Node: ${node.hostname}`,
            "",
            "# Server",
            "[Interface]",
            `PrivateKey = ${node.private_key}`,
            `Address = ${config.VPN.WG_SERVER.IPS.V4}, ${config.VPN.WG_SERVER.IPS.V6}`,
            "ListenPort = 51820",
            ...clients,
        ].join("\n")
    }
}
